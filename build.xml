<?xml version="1.0" encoding="UTF-8"?>
<project name="XCureChatMain" default="deploy" basedir=".">

	<property environment="env"/>
	<property file="build.properties"/>
	<property file="common.build.properties"/>

	<path id="classpath">
		<pathelement location="${build.dir}"/>
		<pathelement location="${src.dir}"/>
		<pathelement location="${gwt.user.jar}"/>
		<pathelement location="${gwt.incubator.jar}"/>
		<pathelement location="${gwt.log.jar}"/>
		<!-- The next two are platform dependent -->
		<pathelement location="${gwt.mac.dev.jar}"/>
		<pathelement location="${gwt.linux.dev.jar}"/>
		<!-- 					-->
		<pathelement location="${gwt.servlet.jar}"/>
		<pathelement location="${gwt.servlet.deps.jar}"/>
		<pathelement location="${gwt.valid.jar}"/>
		<pathelement location="${gwt.valid.src.jar}"/>
		<pathelement location="${servlet-api.jar}"/>
		<pathelement location="${connectorj.jar}"/>
		<pathelement location="${jcaptcha.jar}"/>
		<pathelement location="${log4j.jar}"/>
		<pathelement location="${apache.commons.file.upload.jar}"/>
		<pathelement location="${apache.commons.io.jar}"/>
		<pathelement location="${junit.jar}"/>
		<pathelement location="${html.parser.jar}"/>
		<pathelement location="${html.lexer.jar}"/>
	</path>

	<target name="clean" depends="clean.test" description="Deletes all generated files">
		<delete dir=".gwt-cache"/>		<!-- generated by GWT -->
		<delete dir="${build.dir}"/>	<!-- generated by the prepare target -->
		<delete dir="tomcat"/>			<!-- generated by GWT -->
	</target>

	<target name="clean.test" description="Deletes all generated test files">
		<delete dir="test"/>
	</target>

	<target name="prepare" description="Creates output directories">
		<mkdir dir="${build.dir}"/>
	</target>

	<target name="compile" depends="prepare" description="Compiles Java source files to bytecode">
		<javac srcdir="${src.dir}" destdir="${build.dir}" classpathref="classpath" debug="true" fork="true" includeantruntime="true">
			<compilerarg value="-Xlint:deprecation"/>
		</javac>
	</target>
	
	<target name="compile.gwt" depends="compile" description="Compiles java source files to JavaScript">
		<!-- Consider adding -Xms256m -Xmx512m to improve performance -->
		<java classname="com.google.gwt.dev.Compiler" classpathref="classpath" fork="true">
			<jvmarg line="-Xms256m"/>
			<jvmarg line="-Xmx512m"/>
			<jvmarg line="-Xmx1G"/>
			<jvmarg line="-Xss1024k"/>
			<arg line="-war ${build.dir}/${client.out}"/>
			<!-- Possible styles: OBF[USCATED], PRETTY, or DETAILED (defaults to OBF)        -->
			<!-- Add -compileReport -XsoycDetailed in order to get the deferred loading info -->
			<!-- <arg line="-style DETAILED -compileReport -XsoycDetailed"/> -->
			<arg line="-style OBF"/>
			<arg value="${package}.${module}"/>
		</java>
	</target>

	<target name="war" depends="compile, compile.gwt" description="Builds the war file">
		<delete file="${build.dir}/${war}"/>
		<!-- Delete the unnecessary tmp files generated by GWT -->
		<delete dir="${build.dir}/${client.out}/.gwt-tmp"/>
		<war warfile="${build.dir}/${war}" webxml="${webxml.file}">
			<!-- Bytecode from the java code -->
			<classes dir="${build.dir}" includes="**/*.class"/>
			<!-- The log4j.properties file for the WEB-INF/classes -->
			<classes dir="." includes="${log4j.prop.file}"/>
			<!-- The URL rewrite filter xml to the WEB-INF -->
			<webinf dir="." includes="${url.rewrite.filter.xml}"/>
			<!-- The Configuration file of xcure chat-->
			<classes dir="." includes="${xcure.chat.prop.file}"/>
			<!-- The context.xml file for the META-INF -->
			<metainf dir="." includes="${contextxml.file}"/>
			<!-- Generated html/JavaScript plus our css files and etc. -->
			<fileset dir="${build.dir}/${client.out}/${module}"/>
			<!-- External jar files that we will need -->
			<lib file="${gwt.servlet.jar}"/>
			<lib file="${gwt.servlet.deps.jar}"/>
			<lib file="${gwt.valid.jar}"/>
			<lib file="${gwt.valid.src.jar}"/>
			<lib file="${jcaptcha.jar}"/>
			<lib file="${log4j.jar}"/>
			<lib file="${apache.commons.file.upload.jar}"/>
			<lib file="${apache.commons.io.jar}"/>
			<lib file="${html.parser.jar}"/>
			<lib file="${html.lexer.jar}"/>
			<!-- The URL rewrite filter to the WEB-INF/lib -->
			<lib file="${url.rewrite.filter.jar}"/>
			
			<!-- WARNING: Somehow, when placed in WEB-INF/lib the jdbc
			driver is not found by the connection pool -->
			<!-- <lib file="${connectorj.jar}"/> -->
		</war>
	</target>

	<target name="undeploy" description="Undeploys the web app. from TomCat">
		<delete dir="${tomcat.dir}/webapps/${deployment.context}"/>
		<delete file="${tomcat.dir}/webapps/${war}"/>
	</target>

	<target name="deploy" depends="war, undeploy" description="Deploys the war file to TomCat">
		<copy file="${build.dir}/${war}" todir="${tomcat.dir}/webapps"/>
		<echo>Browse site at: ${url}</echo>
	</target>

	<target name="test" depends="" description="">
	</target>

	<target name="javadoc" depends="" description="">
	</target>
    
    <!-- NOTE: Will not actually work because the server side is not hooked up -->
    <!-- REQUIRES: sudo apt-get install libstdc++5 -->
	<target name="hosted" depends="compile" description="Runs the application in hosted mode">
		<java classname="com.google.gwt.dev.HostedMode" classpathref="classpath" fork="true">
			<!-- Next line is only for Mac OS X -->
			<!--<jvmarg value="-XstartOnFirstThread"/>-->
			<arg line="-startupUrl ${package}.${module}/${module}.html ${package}.${module}"/>
		</java>
	</target>

</project>
